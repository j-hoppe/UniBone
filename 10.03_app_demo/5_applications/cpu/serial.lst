       1                                
       2                                	.title	Serial I/O test for console
       3                                
       4                                	; This program tests the DEC DL11 or Robotron AIS K8060 console interface.
       5                                	; It run in 4 phases:
       6                                	; 1. print a start message,
       7                                	; 2. echoes chars typed to the output until ^C is hit
       8                                	; 3. prints an end message and HALTs.
       9                                	; 4. on CONT it repeats.
      10                                	;
      11                                	; Contact: Joerg Hoppe / j_hoppe@t-online.de / www.retromcp.com
      12                                
      13                                	.asect
      14                                
      15                                	; select one type of console at assembly time
      16 177560                         	dladr = 177560	; base addr of DEC DL11 console
      17                                	; dladr = 176500	 ; DL11 #0
      18                                	; dladr = 176510	; DL11 #1
      19                                	; dladr = 176520	; DL11 #2
      20                                
      21                                
      22 000000                         	.=0
      23 000000 000137  001000          	jmp	@#start 	  ; early emulation started code execution from 0
      24                                
      25 001000                         	.=1000
      26                                
      27 000776                         stack	=	. - 2		; stack growns down from start
      28                                
      29                                start:
      30 001000 012706  000776          	mov	#stack,sp	; init stack
      31                                
      32                                	; 1. print "Hello" msg
      33 001004 012701  001126          	mov	#shello,r1
      34 001010 004737  001054          	call	@#puts
      35                                
      36                                	; 2. echo chars until ^C hit
      37                                1$:
      38 001014 004737  001110          	call	@#getc		; wait for char, return in r0
      39 001020 042700  177600          	bic	#177600,r0	; make 7bit: clear bits <15:7>
      40 001024 120027  000003          	cmpb	r0,#3		; break by ^C ?
      41 001030 001403                  	beq	2$		; yes: leave loop
      42 001032 004737  001070          	call	@#putc		; no: echo char in r0 and loop
      43 001036 000766                  	br	1$
      44                                
      45                                2$:
      46                                
      47                                	; 3. print "Bye bye" msg and HALT
      48 001040 012701  001211          	mov	#sbye,r1
      49 001044 004737  001054          	call	@#puts
      50 001050 000000                  	halt
      51                                
      52                                	; 4. loop on CONT
      53 001052 000752                  	br	start
      54                                
      55                                
      56                                	; ----------------------
      57                                	; puts - print a string
      58                                	; r1 = pointer, r0,r1 changed
      59                                puts:
      60 001054 112100                  	movb	(r1)+,r0	; load xmt char
      61 001056 001403                  	beq	1$		; string ends with 0
      62 001060 004737  001070          	call	@#putc
      63 001064 000773                  	br	puts		; transmit nxt char of string
      64 001066 000207                  1$:	return
      65                                
      66                                
      67                                	; ----------------------
      68                                	; putc - output a single char
      69                                	; r0 = char, r4 changed
      70                                putc:
      71 001070 012704  177560          	mov	#dladr,r4	; set base addr
      72 001074 110064  000006          	movb	r0,6(r4)	; char into transmit buffer
      73 001100 105764  000004          1$:	tstb	4(r4)		; XMT RDY?
      74 001104 100375                  	bpl	1$		; no, loop
      75 001106 000207                  	return
      76                                
      77                                	; ----------------------
      78                                	; getc - input a single char
      79                                	; result in r0, r4 changed
      80                                getc:
      81 001110 012704  177560          	mov	#dladr,r4	; set base addr
      82 001114 105714                  1$:	tstb	(r4)		; RCVR DONE?
      83 001116 100376                  	bpl	1$		; no, loop
      84 001120 016400  000002          	mov	2(r4),r0	; return data
      85 001124 000207                  	return
      86                                
      87                                
      88                                shello:
      89 001126    110     145     154  	.ascii	/Hello, World!/
         001131    154     157     054  
         001134    040     127     157  
         001137    162     154     144  
         001142    041                  
      90 001143    015     012          	.byte	15,12		; CR, LF,
      91 001145    124     171     160  	.ascii	/Typed chars are echoed, ^C HALTs./
         001150    145     144     040  
         001153    143     150     141  
         001156    162     163     040  
         001161    141     162     145  
         001164    040     145     143  
         001167    150     157     145  
         001172    144     054     040  
         001175    136     103     040  
         001200    110     101     114  
         001203    124     163     056  
      92 001206    015     012     000  	.byte	15,12,0 	; CR, LF, NUL=end marker
      93                                sbye:
      94 001211    015     012          	.byte	15,12
      95 001213    107     157     157  	.ascii	/Good bye!/
         001216    144     040     142  
         001221    171     145     041  
      96 001224    015     012     000  	.byte	15,12,0 	; CR, LF, NUL=end marker
      97                                
      98                                	.end
      98                                
